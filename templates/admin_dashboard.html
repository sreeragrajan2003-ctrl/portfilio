{% extends "admin_layout.html" %}
{% set active = "dashboard" %}
{% set page_title = "Dashboard" %}

{% block content %}

<!-- Dashboard Cards -->
<div class="dashboard-cards">

    <div class="card">
        <i class="fas fa-user-shield text-primary"></i>
        <h3>Logged Admin</h3>
        <p>{{ session['admin_username'] }}</p>
    </div>

    <div class="card">
        <i class="fas fa-database text-primary"></i>
        <h3>Total Sections</h3>
        <p>{{ sections|length }}</p>
    </div>

</div>

<hr>

<!-- Quick Actions -->
<div class="action-buttons">
    <a class="btn btn-primary" href="{{ url_for('admin.add_section_head') }}">
        <i class="fas fa-plus"></i> Add Section
    </a>

    <a class="btn btn-secondary" href="{{ url_for('admin.add_subsection') }}">
        <i class="fas fa-plus-circle"></i> Add Subsection
    </a>
</div>

<hr>

<!-- DRAGGABLE SECTIONS -->
<div id="sections-container">

{% for section in sections %}
<div class="section-block" data-id="{{ section.id }}">

    <div class="section-header">

        <div class="section-title-wrap">
            <span class="drag-handle">
                <i class="fas fa-grip-vertical"></i>
            </span>

            <h2>{{ section.section_title }}</h2>
            <span class="section-name">({{ section.section_name }})</span>
        </div>

        <div class="section-actions">
            <a href="{{ url_for('admin.edit_section', id=section.id) }}"
               class="btn btn-sm btn-warning">
                <i class="fas fa-edit"></i>
            </a>

            <a href="{{ url_for('admin.delete_section', id=section.id) }}"
               class="btn btn-sm btn-danger"
               onclick="return confirm('Delete this section and all subsections?');">
                <i class="fas fa-trash"></i>
            </a>
        </div>

    </div>

    <!-- Subsections -->
    <div class="subsection-grid">
        {% for item in section.items %}
        <div class="sub-card">
            <h4>{{ item.content_key }}</h4>
            <p>{{ item.content_value }}</p>

            <div class="sub-actions">
                <a href="{{ url_for('admin.edit_subsection', id=item.id) }}"
                   class="btn btn-sm btn-outline-warning">Edit</a>

                <a href="{{ url_for('admin.delete_subsection', id=item.id) }}"
                   class="btn btn-sm btn-outline-danger"
                   onclick="return confirm('Delete this subsection?');">
                    Delete
                </a>
            </div>
        </div>
        {% endfor %}
    </div>

</div>
{% endfor %}

</div>

<!-- SortableJS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const container = document.getElementById("sections-container");

    if (container) {
        new Sortable(container, {
            handle: ".drag-handle",
            animation: 150,
            ghostClass: "drag-ghost",
            onEnd: function (evt) {
                const ids = [...container.children].map(el => el.dataset.id);

                fetch("{{ url_for('admin.update_section_order') }}", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ order: ids })
                });
            }
        });
    }

});
</script>

{% endblock %}
